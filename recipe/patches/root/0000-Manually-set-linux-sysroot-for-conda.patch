From 98ae61de7c1557562adecfa3b5cd3732cdc5c9a1 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Sun, 2 May 2021 16:09:29 +0200
Subject: [PATCH] Manually set linux sysroot for conda

---
 lib/Driver/ToolChains/Linux.cpp | 49 ++++-----------------------------
 1 file changed, 6 insertions(+), 43 deletions(-)

diff --git a/lib/Driver/ToolChains/Linux.cpp b/lib/Driver/ToolChains/Linux.cpp
index a74eb97..278282e 100644
--- a/lib/Driver/ToolChains/Linux.cpp
+++ b/lib/Driver/ToolChains/Linux.cpp
@@ -469,50 +469,13 @@ Tool *Linux::buildAssembler() const {
 }
 
 std::string Linux::computeSysRoot() const {
-  if (!getDriver().SysRoot.empty())
-    return getDriver().SysRoot;
-
-  if (getTriple().isAndroid()) {
-    // Android toolchains typically include a sysroot at ../sysroot relative to
-    // the clang binary.
-    const StringRef ClangDir = getDriver().getInstalledDir();
-    std::string AndroidSysRootPath = (ClangDir + "/../sysroot").str();
-    if (getVFS().exists(AndroidSysRootPath))
-      return AndroidSysRootPath;
+  if (char *env = ::getenv("CONDA_BUILD_SYSROOT")) {
+    // We only use this value as the default if it is an absolute path and exists
+    if (llvm::sys::path::is_absolute(env) && getVFS().exists(env)) {
+      return env;
+    }
   }
-
-  if (!GCCInstallation.isValid())
-    return std::string();
-
-  // Standalone MIPS toolchains use different names for sysroot folder
-  // and put it into different places. Here we try to check some known
-  // variants.
-
-  const StringRef InstallDir = GCCInstallation.getInstallPath();
-  const StringRef TripleStr = GCCInstallation.getTriple().str();
-  const Multilib &Multilib = GCCInstallation.getMultilib();
-
-  std::string Path =
-      (InstallDir + "/../../../../" + TripleStr + "/libc" + Multilib.osSuffix())
-          .str();
-
-  if (getVFS().exists(Path))
-    return Path;
-
-  Path =
-      (InstallDir + "/../../../../" + TripleStr + "/sysroot")
-          .str();
-
-  if (getVFS().exists(Path))
-    return Path;
-
-
-  Path = (InstallDir + "/../../../../sysroot" + Multilib.osSuffix()).str();
-
-  if (getVFS().exists(Path))
-    return Path;
-
-  return std::string();
+  return "SYSROOT_PATH_TO_BE_REPLACED_WITH_SED";
 }
 
 std::string Linux::getDynamicLinker(const ArgList &Args) const {
-- 
2.30.2

